# Technical Changes in Spartacus 4.0

## Breaking Changes Introduced in 4.0

### NgbTabsetModule

#### StoreFinderComponentsModule
-  Deprecated import `NgbTabsetModule` from `@ng-bootstrap/ng-bootstrap` has been replaced with `NgbNavModule` to support version 8 of the library.

#### StoreFinderListComponent
- Mobile template has been updated to use nav instead of tabs. [See changes.](https://github.com/SAP/spartacus/pull/12398/files#diff-1db586698a503ea500917fe4d734f84d0729f585aa7c4b56705d9171a38e7f55L64-L120)  
- Added styles for `ul.nav` to keep the same appearance.
  
### ASM changes

- `AsmModule` was removed from storefrontlib, and renamed AsmComponentsModule. Use @spartacus/asm/components instead.
- `AsmModule` was removed from core, and renamed AsmCoreModule. Use @spartacus/asm/core. instead.
- `AsmConfig` was removed from core. Use @spartacus/asm/core.
- `AsmAdapter` was removed. Use @spartacus/asm/core instead.
- `AsmConnector` was removed. Use @spartacus/asm/core instead.
- `CUSTOMER_SEARCH_PAGE_NORMALIZER` was removed. Use @spartacus/asm/core instead.
- `AsmService` was removed. Use @spartacus/asm/core instead.
- `CsAgentAuthService` was removed. Use @spartacus/asm/root instead.
- `CustomerSearchPage` was removed. Use @spartacus/asm/core instead.
- `CustomerSearchOptions` was removed. Use @spartacus/asm/core instead.
- `AsmUi` was removed. Use @spartacus/asm/core instead.
- `AsmAuthHttpHeaderService` was removed. Use @spartacus/asm/root instead.
- `TOKEN_TARGET` was removed. Use @spartacus/asm/root instead.
- `AsmAuthService` was removed. Use @spartacus/asm/root instead.
- `AsmAuthStorageService` was removed. Use @spartacus/asm/root instead.
- `SYNCED_ASM_STATE` was removed. Use @spartacus/asm/core instead.
- `AsmStatePersistenceService` was removed. Use @spartacus/asm/core instead.
- `ASM_UI_UPDATE` was removed. Use @spartacus/asm/core instead.
- `AsmUiUpdate` was removed. Use @spartacus/asm/core instead.
- `AsmUiAction` was removed. Use @spartacus/asm/core instead.
- `CUSTOMER_SEARCH` was removed. Use @spartacus/asm/core instead.
- `CUSTOMER_SEARCH_FAIL` was removed. Use @spartacus/asm/core instead.
- `CUSTOMER_SEARCH_SUCCESS` was removed. Use @spartacus/asm/core instead.
- `CUSTOMER_SEARCH_RESET` was removed. Use @spartacus/asm/core instead.
- `CustomerSearch` was removed. Use @spartacus/asm/core instead.
- `CustomerSearchFail` was removed. Use @spartacus/asm/core instead.
- `CustomerSearchSuccess` was removed. Use @spartacus/asm/core instead.
- `CustomerSearchReset` was removed. Use @spartacus/asm/core instead.
- `CustomerAction` was removed. Use @spartacus/asm/core instead.
- `LOGOUT_CUSTOMER_SUPPORT_AGENT` was removed. Use @spartacus/asm/core instead.
- `LogoutCustomerSupportAgent` was removed. Use @spartacus/asm/core instead.
- `ASM_FEATURE` was removed. Use @spartacus/asm/core instead.
- `CUSTOMER_SEARCH_DATA` was removed. Use @spartacus/asm/core instead.
- `StateWithAsm` was removed. Use @spartacus/asm/core instead.
- `AsmState` was removed. Use @spartacus/asm/core instead.
- `getAsmUi` was removed. Use @spartacus/asm/core instead.
- `getCustomerSearchResultsLoaderState` was removed. Use @spartacus/asm/core instead.
- `getCustomerSearchResults` was removed. Use @spartacus/asm/core instead.
- `getCustomerSearchResultsLoading` was removed. Use @spartacus/asm/core instead.
- `getAsmState` was removed. Use @spartacus/asm/core instead.

### LaunchDialogService

#### SavedCartFormLaunchDialogService
- Service has been removed. `openDialog` method is part of LaunchDialogService now.

#### AddToSavedCartComponent 
- Removed `SavedCartFormLaunchDialogService` from constructor.
- Added `LaunchDialogService` to constructor.

#### SavedCartDetailsActionComponent
- Removed `SavedCartFormLaunchDialogService` from constructor.
- Added `LaunchDialogService` to constructor.

#### SavedCartDetailsOverviewComponent
- Removed `SavedCartFormLaunchDialogService` from constructor.
- Added `LaunchDialogService` to constructor.

#### AnonymousConsentLaunchDialogService
- Service has been removed. `openDialog` method is part of LaunchDialogService now.

#### AnonymousConsentManagementBannerComponent
- Removed `AnonymousConsentLaunchDialogService` from constructor.
- Added `LaunchDialogService` to constructor.

#### AnonymousConsentOpenDialogComponent
- Removed `AnonymousConsentLaunchDialogService` from constructor.
- Added `LaunchDialogService` to constructor.

#### ReplenishmentOrderCancellationLaunchDialogService
- Service has been removed. `openDialog` method is part of LaunchDialogService now.

#### ReplenishmentOrderCancellationComponent
- Removed `ReplenishmentOrderCancellationLaunchDialogService` from constructor.
- Added `LaunchDialogService` to constructor.

#### ReplenishmentOrderHistoryComponent
- Removed `ReplenishmentOrderCancellationLaunchDialogService` from constructor.
- Added `LaunchDialogService` to constructor.

### Personalization

- `PersonalizationModule` was removed. Use `@spartacus/tracking/personalization` instead.
- `PersonalizationConfig` was moved to `@spartacus/tracking/personalization/root`.
- `PersonalizationContextService` was moved to `@spartacus/tracking/personalization/core`.
- `PersonalizationAction` was moved to `@spartacus/tracking/personalization/core`.
- `PersonalizationContext` was moved to `@spartacus/tracking/personalization/core`.

### WindowRef

- `platformId` is now required constructor dependency.

### Product configurator

`ConfiguratorCartEntryInfoComponent` now also requires `CommonConfiguratorUtilsService`.
`ConfiguratorAttributeCheckboxListComponent` now also requires `ConfiguratorAttributeQuantityService`.
`ConfiguratorAttributeDropDownComponent` now also requires `ConfiguratorAttributeQuantityService`.
`ConfiguratorAttributeRadiButtonComponent` now also requires `ConfiguratorAttributeQuantityService`.
`ConfiguratorStorefrontUtilsService` now also requires `KeyboardFocusService`.

### Product variants changes

#### Automated Migrations for Version 4.0

- `ProductVariantsModule` was removed from @spartacus/storefront. Use `@spartacus/product/variants` feature-library instead.
- `ProductVariantsComponent` was removed from @spartacus/storefront. Use `ProductVariantsContainerComponent` from `@spartacus/product/variants/components` as a replacement.
- `VariantColorSelectorComponent` was removed from @spartacus/storefront. Use `ProductVariantColorSelectorComponent` from `@spartacus/product/variants/components` as a replacement.
- `VariantColorSelectorModule` was removed from @spartacus/storefront. Use `ProductVariantColorSelectorModule` from `@spartacus/product/variants/components` as a replacement.
- `VariantSizeSelectorComponent` was removed from @spartacus/storefront. Use `ProductVariantSizeSelectorComponent` from `@spartacus/product/variants/components` as a replacement.
- `VariantSizeSelectorModule` was removed from @spartacus/storefront. Use `ProductVariantSizeSelectorModule` from `@spartacus/product/variants/components` as a replacement.
- `VariantStyleSelectorComponent` was removed from @spartacus/storefront. Use `ProductVariantStyleSelectorComponent` from `@spartacus/product/variants/components` as a replacement.
- `VariantStyleSelectorModule` was removed from @spartacus/storefront. Use `ProductVariantStyleSelectorModule` from `@spartacus/product/variants/components` as a replacement.
- `VariantStyleIconsComponent` was removed from @spartacus/storefront. Use `ProductVariantStyleIconsComponent` from `@spartacus/product/variants/root` as a replacement.
- `ProductVariantStyleIconsComponent` was moved from `@spartacus/product/variants/components`to `@spartacus/product/variants/root` instead.
- `VariantStyleIconsModule` was removed from @spartacus/storefront. Use `ProductVariantStyleIconsModule` from `@spartacus/product/variants/root` as a replacement.
- `ProductVariantStyleIconsModule` was moved from `@spartacus/product/variants/components`to `@spartacus/product/variants/root` instead.
- `ProductVariantGuard` was removed from @spartacus/storefront. Use `ProductVariantsGuard` from `@spartacus/product/variants/components` instead. Additionally method: `findVariant` was renamed to `findPurchasableProductCode`.

#### Product variants i18n

- translation namespace `variant` was removed from `@spartacus/assets`. Use namespace `variants` that can be imported with `productVariantsTranslations` and `productVariantsTranslationChunksConfig` from `@spartacus/product/variants/assets` instead. Translation keys from this namespace did not changed.

#### Product variants endpoint scope

- scope `variants` was removed from `defaultOccProductConfig`. It's now provided by `ProductVariantsOccModule` under `@spartacus/product/variants/occ` instead. Additionally the endpoint now uses `orgProducts` API instead of `products`.

#### Product variants styles

- styles for `cx-product-variants` were removed from `@spartacus/styles`. Use `@spartacus/product/variants` import instead.

### Feature keys for product configurators

The feature keys that are used to lazily load the product configurator libraries in app.module.ts were available as `rulebased` and `productConfiguratorRulebased` from 3.1 onwards (respective `textfield` and `productConfiguratorTextfield` for the textfield template configurator).

In 4.0, only the longer versions `productConfiguratorRulebased` and `productConfiguratorTextfield` are possible.

Example: A configuration

```
      featureModules: {
        rulebased: {
          module: () => import('@spartacus/product-configurator/rulebased').then(
          (m) => m.RulebasedConfiguratorModule
        ),
        },
      }
```

needs to look like that in 4.0

```
      featureModules: {
        productConfiguratorRulebased: {
          module: () => import('@spartacus/product-configurator/rulebased').then(
          (m) => m.RulebasedConfiguratorModule
        ),
        },
      }
```

### Translations (i18n) changed

- Key `asm.standardSessionInProgress` was removed.

### Storage Sync mechanism

I version 4.0 we removed deprecated in version 3.0 storage sync mechanism. In previous major release we provided more powerful mechanism based on `StatePersistenceService` which can cover all use cases for synchronizing data to and from browser storage (eg. `localStorage`, `sessionStorage`) better than the removed storage sync.

What was removed:

- core of the mechanism (reducer)
- configuration (`storageSync` from `StateConfig`)
- default config and default keys (`defaultStateConfig`, `DEFAULT_LOCAL_STORAGE_KEY` and `DEFAULT_SESSION_STORAGE_KEY`)

### LanguageService

- `LanguageService` no longer uses `WindowRef`. The language initialization from the state was moved to `LanguageInitializer`.
- `LanguageService` now validate the value passed to the method `setActive()` against the iso codes listed in the Spartacus `context` config, before setting the actual value in the ngrx store.
- The initialization of the site context is scheduled a bit earlier than in before (now it's run in an observable stream instead of a Promise's callback). It's a very slight change, but might have side-effects in some custom implementations.
- The active language is now persisted in the Local Storage instead of the Session Storage

### CurrencyService

- `CurrencyService` no longer uses `WindowRef`. The currency initialization from the state was moved to `CurrencyInitializer`.
- `CurrencyService` now validate the value passed to the method `setActive()` against the iso codes listed in the Spartacus `context` config, before setting the actual value in the ngrx store.
- The initialization of the site context is scheduled a bit earlier than in before (now it's run in an observable stream instead of a Promise's callback). It's a very slight change, but might have side-effects in some custom implementations.
- The active currency is now persisted in the LocalStorage instead of the Session Storage.

### Page resolvers

In 3.1 and 3.2 we've introduced a few changes on how the page meta data is collected. The resolvers are now configurable and whether they render on the client or server (SSR) is also configurable. A few resolvers are changed or added, since most data is now configurable in the backend (description, robots). The robot information that was previously hardcoded in some resolvers, are now driven by backend data. 

A new feature has landed in the product and category resolvers for the canonical URL.

The `BasePageMetaResolver` is leveraged to compose most of the generic page meta data. Most page resolvers now use the page data to create the description and robot tags. The changes have affected the following resolver classes:

- The `PageMetaService` has a dependency on `UnifiedInjector`, `PageMetaConfig` and the `platformId`.
- The `ContentPageMetaResolver` depends only on the `BasePageMetaResolver`.
- The `BasePageMetaResolver` requires the `Router` and `PageLinkService` to add canonical links to the page meta.
- The `ProductPageMetaResolver` requires the `BasePageMetaResolver` and `PageLinkService`.
- The `CategoryPageMetaResolver` requires the `BasePageMetaResolver`.
- The `SearchPageMetaResolver` requires the `BasePageMetaResolver`.
- The `CheckoutPageMetaResolver` uses the  `BasePageMetaResolver`.
- The `OrganizationPageMetaResolver` no longer uses the `BasePageMetaResolver`.
- The `RoutingService` uses the `Router` to resolve the full URL (used to resolve the canonical URL in the page meta resolvers)

The `CmsPageTitleModule` is renamed to  `PageMetaModule`.
The `CartPageMetaResolver` is removed since all content is resolved by the generic `ContentPageMetaResolver`.

The following properties where removed in 4.0:

- The `ContentPageMetaResolver` no longer supports the `homeBreadcrumb$`,`breadcrumb$`,`title$` and `cms$` as the content is resolved by the `BasePageMetaResolver`.
- The `resolverMethods` property on the `PageMetaService` has changed to `resolvers$` since the resolvers are read from the configuration stream.

### SelectiveCartService

- The `getLoaded` method was removed. Use `isStable` method instead.

### SearchBoxComponentService

- `SearchBoxComponentService` now also requires `EventService`.

### AddedToCartDialogComponent

- The `increment` property was removed. Use property `numberOfEntriesBeforeAdd` instead.

### CartListItemComponent

- Removed `FeatureConfigService` from constructor and added `UserIdService` and `MultiCartService` to constructor.
- Property `form: FormGroup` is now initialized on component creation instead of in the `createForm()` method.
- `ngOnInit()` method has been modified to fix an issue with rendering items.
- `[class.is-changed]` template attribute on `<div>` tag now depends on method `control.get('quantity').disabled`.

### Models

- The `Item` interface was removed.
