<nav>
  <ul>
    <li *ngIf="flyout && node?.children.length > 1" class="back is-open">
      <button>
        <cx-icon [type]="iconType.CARET_LEFT" (click)="back()"></cx-icon>
        {{ 'common.back' | cxTranslate }}
      </button>
    </li>

    <ng-container *ngFor="let child of node?.children">
      <li>
        <ng-container
          *ngTemplateOutlet="nav; context: { node: child, depth: 0 }"
        >
        </ng-container>
      </li>
    </ng-container>
  </ul>
</nav>
<!-- we generate links in a recursive manner -->

<ng-template #nav let-node="node" let-depth="depth">
  <!--  <nav>-->
  <cx-generic-link
    *ngIf="
      node.url && (!node.children || node.children?.length === 0);
      else heading
    "
    [url]="node.url"
    [target]="node.target"
    [style]="node.styleAttributes"
    [class]="node.styleClasses"
  >
    {{ node.title }}
    <cx-icon
      *ngIf="flyout && node.children?.length > 0"
      [type]="iconType.CARET_DOWN"
    ></cx-icon>
  </cx-generic-link>

  <ng-template #heading>
    <ng-container *ngIf="flyout && node.children?.length > 0; else span">
      <cx-generic-link *ngIf="node.url" [url]="node.url" [target]="node.target">
        {{ node.title }}
      </cx-generic-link>
      <button
        *ngIf="depth === 0; else title"
        [attr.tabindex]="0"
        [attr.aria-haspopup]="true"
        (click)="toggleOpen($event)"
        (mouseenter)="onMouseEnter($event)"
        (keydown.space)="toggleOpen($event)"
        (keydown.esc)="back()"
      >
        <ng-container *ngIf="!node.url">
          {{ node.title }}
        </ng-container>
        <cx-icon [type]="iconType.CARET_DOWN"></cx-icon>
      </button>
      <ng-template #title>
        <button [attr.tabindex]="0" [attr.aria-haspopup]="true">
          {{ node.title }}
          <!--          <cx-icon [type]="iconType.CARET_DOWN"></cx-icon>-->
        </button>
      </ng-template>
    </ng-container>
    <ng-template #span>
      <span [attr.tabindex]="-1">
        {{ node.title }}
      </span>
    </ng-template>
  </ng-template>

  <!-- we add a wrapper to allow for better layout handling in CSS -->
  <div class="wrapper" *ngIf="node.children?.length > 0">
    <ul
      class="childs"
      [attr.depth]="getTotalDepth(node)"
      [attr.wrap-after]="node.children?.length > wrapAfter ? wrapAfter : null"
      [attr.columns]="getColumnCount(node.children?.length)"
    >
      <ng-container *ngFor="let child of node.children">
        <li>
          <ng-container
            *ngTemplateOutlet="nav; context: { node: child, depth: depth + 1 }"
          >
          </ng-container>
        </li>
      </ng-container>
    </ul>
  </div>
  <!--  </nav>-->
</ng-template>
