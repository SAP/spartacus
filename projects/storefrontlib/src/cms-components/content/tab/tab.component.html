<ng-container *ngIf="config as config">
  <ng-container *ngIf="mode$ | async as mode">
    <ng-container *ngIf="tabs$ | async as tabs">
      <!-- Tab List is the list of buttons to open tabs -->
      <div role="tablist" [attr.aria-label]="config.label" [class]="mode">
        <ng-container *ngFor="let tab of tabs; let i = index">
          <button
            role="tab"
            (click)="select(i, mode)"
            (keydown)="handleKeydownEvent(i, tabs, mode, $event)"
            [attr.aria-selected]="isOpen(i)"
            [attr.aria-expanded]="isOpen(i)"
            [attr.aria-controls]="'section-' + i"
            [attr.tabindex]="
              isOpen(i) ||
              (i === 0 && (this.openTabs | async) === 0) ||
              mode === 'ACCORDIAN'
                ? 0
                : -1
            "
            [attr.id]="tab.id"
            [class.active]="isOpen(i)"
            #tabHeader
          >
            {{ tab.headerKey ? (tab.headerKey | cxTranslate) : tab.header }}
          </button>

          <!-- Show tab panels under selected button in Accordian mode -->
          <ng-container
            *ngIf="mode === 'ACCORDIAN' && isOpen(i)"
            [ngTemplateOutlet]="tabPanel"
            [ngTemplateOutletContext]="{ tabNum: i }"
          ></ng-container>
        </ng-container>
      </div>

      <!-- Show selected tab panel under all buttons in Tab mode -->
      <ng-container *ngIf="mode === 'TAB'">
        <ng-container
          *ngFor="let tab of tabs; let i = index"
          [ngTemplateOutlet]="tabPanel"
          [ngTemplateOutletContext]="{ tabNum: i }"
        >
        </ng-container
      ></ng-container>

      <!-- Tab Panel shows the content of the given tab -->
      <ng-template #tabPanel let-tabNum="tabNum">
        <div
          role="tabpanel"
          [attr.aria-labelledby]="tabs[tabNum]?.id"
          [attr.id]="'section-' + tabNum"
          [attr.tabindex]="isOpen(tabNum) ? 0 : -1"
          [class.active]="isOpen(tabNum)"
          [style.display]="isOpen(tabNum) ? 'block' : 'none'"
          [cxFocus]="{ focusOnEscape: true }"
        >
          <ng-container
            [ngTemplateOutlet]="tabs[tabNum]?.template"
          ></ng-container>

          <ng-template
            *ngIf="tabs[tabNum]?.cxComponent as component"
            [cxOutlet]="component.flexType"
            [cxOutletContext]="{}"
            #componentTemplate
          >
            <ng-container [cxComponentWrapper]="component"></ng-container>
          </ng-template>
        </div>
      </ng-template>
    </ng-container>
  </ng-container>
</ng-container>
