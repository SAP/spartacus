/*
 * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 */
import { isPlatformBrowser } from '@angular/common';
import { Inject, Injectable, isDevMode, PLATFORM_ID } from '@angular/core';
import { defer, of } from 'rxjs';
import { filter, map, shareReplay, switchMap } from 'rxjs/operators';
import { resolveApplicable } from '../../util/applicable';
import { uniteLatest } from '../../util/rxjs/unite-latest';
import { PageMetaResolver } from '../page/page-meta.resolver';
import * as i0 from "@angular/core";
import * as i1 from "./cms.service";
import * as i2 from "../../lazy-loading/unified-injector";
import * as i3 from "../page/config/page-meta.config";
/**
 * Service that collects the page meta data by using injected page resolvers.
 */
export class PageMetaService {
    constructor(cms, unifiedInjector, pageMetaConfig, platformId) {
        this.cms = cms;
        this.unifiedInjector = unifiedInjector;
        this.pageMetaConfig = pageMetaConfig;
        this.platformId = platformId;
        this.resolvers$ = this.unifiedInjector
            .getMulti(PageMetaResolver)
            .pipe(shareReplay({ bufferSize: 1, refCount: true }));
        this.meta$ = defer(() => this.cms.getCurrentPage()).pipe(filter((page) => Boolean(page)), switchMap((page) => this.getMetaResolver(page)), switchMap((metaResolver) => metaResolver ? this.resolve(metaResolver) : of(null)), shareReplay({ bufferSize: 1, refCount: true }));
    }
    /**
     * Returns the observed page meta data for the current page.
     *
     * The data is resolved by various PageResolvers, which are configurable.
     */
    getMeta() {
        return this.meta$;
    }
    /**
     * If a `PageResolver` has implemented a resolver interface, the resolved data
     * is merged into the `PageMeta` object.
     * @param metaResolver
     */
    resolve(metaResolver) {
        const resolverMethods = this.getResolverMethods();
        const resolvedData = Object.keys(resolverMethods)
            // TODO: Revisit if typing is possible here with Template Literal Types when we update to TS >=4.1
            .filter((key) => metaResolver[resolverMethods[key]])
            .map((key) => {
            return metaResolver[resolverMethods[key]]()
                .pipe(map((data) => ({ [key]: data })));
        });
        if (resolvedData.length === 0) {
            // uniteLatest will fail otherwise
            return of({});
        }
        else {
            return uniteLatest(resolvedData).pipe(map((data) => Object.assign({}, ...data)));
        }
    }
    /**
     * Returns an object with resolvers. The object properties represent the `PageMeta` property, i.e.:
     *
     * ```
     * {
     *   title: 'resolveTitle',
     *   robots: 'resolveRobots'
     * }
     * ```
     *
     * This list of resolvers is filtered for CSR vs SSR processing since not all resolvers are
     * relevant during browsing.
     */
    getResolverMethods() {
        const resolverMethods = {};
        // filter the resolvers to avoid unnecessary processing in CSR
        this.pageMetaConfig?.pageMeta?.resolvers
            ?.filter((resolver) => {
            return (
            // always resolve in SSR
            !isPlatformBrowser(this.platformId ?? '') ||
                // resolve in CSR when it's not disabled
                !resolver.disabledInCsr ||
                // resolve in CSR when resolver is enabled in devMode
                (isDevMode() && this.pageMetaConfig?.pageMeta?.enableInDevMode));
        })
            .forEach((resolver) => (resolverMethods[resolver.property] = resolver.method));
        return resolverMethods;
    }
    /**
     * Return the resolver with the best match, based on a score
     * generated by the resolver.
     *
     * Resolvers match by default on `PageType` and `page.template`.
     */
    getMetaResolver(page) {
        return this.resolvers$.pipe(map((resolvers) => resolveApplicable(resolvers, [page], [page])));
    }
}
PageMetaService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: PageMetaService, deps: [{ token: i1.CmsService }, { token: i2.UnifiedInjector }, { token: i3.PageMetaConfig }, { token: PLATFORM_ID }], target: i0.ɵɵFactoryTarget.Injectable });
PageMetaService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: PageMetaService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: PageMetaService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: function () { return [{ type: i1.CmsService }, { type: i2.UnifiedInjector }, { type: i3.PageMetaConfig }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [PLATFORM_ID]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFnZS1tZXRhLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9jb3JlL3NyYy9jbXMvZmFjYWRlL3BhZ2UtbWV0YS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7O0dBSUc7QUFFSCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsV0FBVyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNFLE9BQU8sRUFBRSxLQUFLLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzdDLE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVyRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFHM0QsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7Ozs7O0FBRzlEOztHQUVHO0FBSUgsTUFBTSxPQUFPLGVBQWU7SUFDMUIsWUFDWSxHQUFlLEVBQ2YsZUFBZ0MsRUFDaEMsY0FBOEIsRUFDVCxVQUFrQjtRQUh2QyxRQUFHLEdBQUgsR0FBRyxDQUFZO1FBQ2Ysb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBQ2hDLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUNULGVBQVUsR0FBVixVQUFVLENBQVE7UUFHekMsZUFBVSxHQUFtQyxJQUFJLENBQUMsZUFBZTthQUN4RSxRQUFRLENBQUMsZ0JBQWdCLENBQUM7YUFDMUIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFLFVBQVUsRUFBRSxDQUFDLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxDQUFDLENBRXJELENBQUM7UUFFUSxVQUFLLEdB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SUFBSSxDQUN6QixHQUFHLENBQUMsQ0FBQyxTQUFTLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUNqRSxDQUFDO0lBQ0osQ0FBQzs7NEdBekdVLGVBQWUseUdBS2hCLFdBQVc7Z0hBTFYsZUFBZSxjQUZkLE1BQU07MkZBRVAsZUFBZTtrQkFIM0IsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkI7OzBCQU1JLE1BQU07MkJBQUMsV0FBVyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBTUERYLUZpbGVDb3B5cmlnaHRUZXh0OiAyMDIzIFNBUCBTcGFydGFjdXMgdGVhbSA8c3BhcnRhY3VzLXRlYW1Ac2FwLmNvbT5cbiAqXG4gKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMFxuICovXG5cbmltcG9ydCB7IGlzUGxhdGZvcm1Ccm93c2VyIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgaXNEZXZNb2RlLCBQTEFURk9STV9JRCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgZGVmZXIsIE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaWx0ZXIsIG1hcCwgc2hhcmVSZXBsYXksIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFVuaWZpZWRJbmplY3RvciB9IGZyb20gJy4uLy4uL2xhenktbG9hZGluZy91bmlmaWVkLWluamVjdG9yJztcbmltcG9ydCB7IHJlc29sdmVBcHBsaWNhYmxlIH0gZnJvbSAnLi4vLi4vdXRpbC9hcHBsaWNhYmxlJztcbmltcG9ydCB7IHVuaXRlTGF0ZXN0IH0gZnJvbSAnLi4vLi4vdXRpbC9yeGpzL3VuaXRlLWxhdGVzdCc7XG5pbXBvcnQgeyBQYWdlLCBQYWdlTWV0YSB9IGZyb20gJy4uL21vZGVsL3BhZ2UubW9kZWwnO1xuaW1wb3J0IHsgUGFnZU1ldGFDb25maWcgfSBmcm9tICcuLi9wYWdlL2NvbmZpZy9wYWdlLW1ldGEuY29uZmlnJztcbmltcG9ydCB7IFBhZ2VNZXRhUmVzb2x2ZXIgfSBmcm9tICcuLi9wYWdlL3BhZ2UtbWV0YS5yZXNvbHZlcic7XG5pbXBvcnQgeyBDbXNTZXJ2aWNlIH0gZnJvbSAnLi9jbXMuc2VydmljZSc7XG5cbi8qKlxuICogU2VydmljZSB0aGF0IGNvbGxlY3RzIHRoZSBwYWdlIG1ldGEgZGF0YSBieSB1c2luZyBpbmplY3RlZCBwYWdlIHJlc29sdmVycy5cbiAqL1xuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCcsXG59KVxuZXhwb3J0IGNsYXNzIFBhZ2VNZXRhU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByb3RlY3RlZCBjbXM6IENtc1NlcnZpY2UsXG4gICAgcHJvdGVjdGVkIHVuaWZpZWRJbmplY3RvcjogVW5pZmllZEluamVjdG9yLFxuICAgIHByb3RlY3RlZCBwYWdlTWV0YUNvbmZpZzogUGFnZU1ldGFDb25maWcsXG4gICAgQEluamVjdChQTEFURk9STV9JRCkgcHJvdGVjdGVkIHBsYXRmb3JtSWQ6IHN0cmluZ1xuICApIHt9XG5cbiAgcHJvdGVjdGVkIHJlc29sdmVycyQ6IE9ic2VydmFibGU8UGFnZU1ldGFSZXNvbHZlcltdPiA9IHRoaXMudW5pZmllZEluamVjdG9yXG4gICAgLmdldE11bHRpKFBhZ2VNZXRhUmVzb2x2ZXIpXG4gICAgLnBpcGUoc2hhcmVSZXBsYXkoeyBidWZmZXJTaXplOiAxLCByZWZDb3VudDogdHJ1ZSB9KSkgYXMgT2JzZXJ2YWJsZTxcbiAgICBQYWdlTWV0YVJlc29sdmVyW11cbiAgPjtcblxuICBwcm90ZWN0ZWQgbWV0YSQ6IE9ic2VydmFibGU8UGFnZU1ldGEgfCBudWxsPiA9IGRlZmVyKCgpID0+XG4gICAgdGhpcy5jbXMuZ2V0Q3VycmVudFBhZ2UoKVxuICApLnBpcGUoXG4gICAgZmlsdGVyKChwYWdlKSA9PiBCb29sZWFuKHBhZ2UpKSxcbiAgICBzd2l0Y2hNYXAoKHBhZ2U6IFBhZ2UpID0+IHRoaXMuZ2V0TWV0YVJlc29sdmVyKHBhZ2UpKSxcbiAgICBzd2l0Y2hNYXAoKG1ldGFSZXNvbHZlcjogUGFnZU1ldGFSZXNvbHZlciB8IHVuZGVmaW5lZCkgPT5cbiAgICAgIG1ldGFSZXNvbHZlciA/IHRoaXMucmVzb2x2ZShtZXRhUmVzb2x2ZXIpIDogb2YobnVsbClcbiAgICApLFxuICAgIHNoYXJlUmVwbGF5KHsgYnVmZmVyU2l6ZTogMSwgcmVmQ291bnQ6IHRydWUgfSlcbiAgKTtcblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgb2JzZXJ2ZWQgcGFnZSBtZXRhIGRhdGEgZm9yIHRoZSBjdXJyZW50IHBhZ2UuXG4gICAqXG4gICAqIFRoZSBkYXRhIGlzIHJlc29sdmVkIGJ5IHZhcmlvdXMgUGFnZVJlc29sdmVycywgd2hpY2ggYXJlIGNvbmZpZ3VyYWJsZS5cbiAgICovXG4gIGdldE1ldGEoKTogT2JzZXJ2YWJsZTxQYWdlTWV0YSB8IG51bGw+IHtcbiAgICByZXR1cm4gdGhpcy5tZXRhJDtcbiAgfVxuXG4gIC8qKlxuICAgKiBJZiBhIGBQYWdlUmVzb2x2ZXJgIGhhcyBpbXBsZW1lbnRlZCBhIHJlc29sdmVyIGludGVyZmFjZSwgdGhlIHJlc29sdmVkIGRhdGFcbiAgICogaXMgbWVyZ2VkIGludG8gdGhlIGBQYWdlTWV0YWAgb2JqZWN0LlxuICAgKiBAcGFyYW0gbWV0YVJlc29sdmVyXG4gICAqL1xuICBwcm90ZWN0ZWQgcmVzb2x2ZShtZXRhUmVzb2x2ZXI6IFBhZ2VNZXRhUmVzb2x2ZXIpOiBPYnNlcnZhYmxlPFBhZ2VNZXRhPiB7XG4gICAgY29uc3QgcmVzb2x2ZXJNZXRob2RzID0gdGhpcy5nZXRSZXNvbHZlck1ldGhvZHMoKTtcbiAgICBjb25zdCByZXNvbHZlZERhdGE6IE9ic2VydmFibGU8UGFnZU1ldGE+W10gPSBPYmplY3Qua2V5cyhyZXNvbHZlck1ldGhvZHMpXG4gICAgICAvLyBUT0RPOiBSZXZpc2l0IGlmIHR5cGluZyBpcyBwb3NzaWJsZSBoZXJlIHdpdGggVGVtcGxhdGUgTGl0ZXJhbCBUeXBlcyB3aGVuIHdlIHVwZGF0ZSB0byBUUyA+PTQuMVxuICAgICAgLmZpbHRlcigoa2V5KSA9PiAobWV0YVJlc29sdmVyIGFzIGFueSlbcmVzb2x2ZXJNZXRob2RzW2tleV1dKVxuICAgICAgLm1hcCgoa2V5KSA9PiB7XG4gICAgICAgIHJldHVybiAobWV0YVJlc29sdmVyIGFzIGFueSlcbiAgICAgICAgICBbcmVzb2x2ZXJNZXRob2RzW2tleV1dKClcbiAgICAgICAgICAucGlwZShtYXAoKGRhdGEpID0+ICh7IFtrZXldOiBkYXRhIH0pKSk7XG4gICAgICB9KTtcblxuICAgIGlmIChyZXNvbHZlZERhdGEubGVuZ3RoID09PSAwKSB7XG4gICAgICAvLyB1bml0ZUxhdGVzdCB3aWxsIGZhaWwgb3RoZXJ3aXNlXG4gICAgICByZXR1cm4gb2Yoe30pO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdW5pdGVMYXRlc3QocmVzb2x2ZWREYXRhKS5waXBlKFxuICAgICAgICBtYXAoKGRhdGEpID0+IE9iamVjdC5hc3NpZ24oe30sIC4uLmRhdGEpKVxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhbiBvYmplY3Qgd2l0aCByZXNvbHZlcnMuIFRoZSBvYmplY3QgcHJvcGVydGllcyByZXByZXNlbnQgdGhlIGBQYWdlTWV0YWAgcHJvcGVydHksIGkuZS46XG4gICAqXG4gICAqIGBgYFxuICAgKiB7XG4gICAqICAgdGl0bGU6ICdyZXNvbHZlVGl0bGUnLFxuICAgKiAgIHJvYm90czogJ3Jlc29sdmVSb2JvdHMnXG4gICAqIH1cbiAgICogYGBgXG4gICAqXG4gICAqIFRoaXMgbGlzdCBvZiByZXNvbHZlcnMgaXMgZmlsdGVyZWQgZm9yIENTUiB2cyBTU1IgcHJvY2Vzc2luZyBzaW5jZSBub3QgYWxsIHJlc29sdmVycyBhcmVcbiAgICogcmVsZXZhbnQgZHVyaW5nIGJyb3dzaW5nLlxuICAgKi9cbiAgcHJvdGVjdGVkIGdldFJlc29sdmVyTWV0aG9kcygpOiB7IFtwcm9wZXJ0eTogc3RyaW5nXTogc3RyaW5nIH0ge1xuICAgIGNvbnN0IHJlc29sdmVyTWV0aG9kczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9O1xuICAgIC8vIGZpbHRlciB0aGUgcmVzb2x2ZXJzIHRvIGF2b2lkIHVubmVjZXNzYXJ5IHByb2Nlc3NpbmcgaW4gQ1NSXG4gICAgdGhpcy5wYWdlTWV0YUNvbmZpZz8ucGFnZU1ldGE/LnJlc29sdmVyc1xuICAgICAgPy5maWx0ZXIoKHJlc29sdmVyKSA9PiB7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgLy8gYWx3YXlzIHJlc29sdmUgaW4gU1NSXG4gICAgICAgICAgIWlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm1JZCA/PyAnJykgfHxcbiAgICAgICAgICAvLyByZXNvbHZlIGluIENTUiB3aGVuIGl0J3Mgbm90IGRpc2FibGVkXG4gICAgICAgICAgIXJlc29sdmVyLmRpc2FibGVkSW5Dc3IgfHxcbiAgICAgICAgICAvLyByZXNvbHZlIGluIENTUiB3aGVuIHJlc29sdmVyIGlzIGVuYWJsZWQgaW4gZGV2TW9kZVxuICAgICAgICAgIChpc0Rldk1vZGUoKSAmJiB0aGlzLnBhZ2VNZXRhQ29uZmlnPy5wYWdlTWV0YT8uZW5hYmxlSW5EZXZNb2RlKVxuICAgICAgICApO1xuICAgICAgfSlcbiAgICAgIC5mb3JFYWNoKFxuICAgICAgICAocmVzb2x2ZXIpID0+IChyZXNvbHZlck1ldGhvZHNbcmVzb2x2ZXIucHJvcGVydHldID0gcmVzb2x2ZXIubWV0aG9kKVxuICAgICAgKTtcbiAgICByZXR1cm4gcmVzb2x2ZXJNZXRob2RzO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybiB0aGUgcmVzb2x2ZXIgd2l0aCB0aGUgYmVzdCBtYXRjaCwgYmFzZWQgb24gYSBzY29yZVxuICAgKiBnZW5lcmF0ZWQgYnkgdGhlIHJlc29sdmVyLlxuICAgKlxuICAgKiBSZXNvbHZlcnMgbWF0Y2ggYnkgZGVmYXVsdCBvbiBgUGFnZVR5cGVgIGFuZCBgcGFnZS50ZW1wbGF0ZWAuXG4gICAqL1xuICBwcm90ZWN0ZWQgZ2V0TWV0YVJlc29sdmVyKFxuICAgIHBhZ2U6IFBhZ2VcbiAgKTogT2JzZXJ2YWJsZTxQYWdlTWV0YVJlc29sdmVyIHwgdW5kZWZpbmVkPiB7XG4gICAgcmV0dXJuIHRoaXMucmVzb2x2ZXJzJC5waXBlKFxuICAgICAgbWFwKChyZXNvbHZlcnMpID0+IHJlc29sdmVBcHBsaWNhYmxlKHJlc29sdmVycywgW3BhZ2VdLCBbcGFnZV0pKVxuICAgICk7XG4gIH1cbn1cbiJdfQ==