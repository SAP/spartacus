{"version":3,"file":"spartacus-tracking-personalization-core.mjs","sources":["../../../feature-libs/tracking/personalization/core/personalization-core.module.ts","../../../feature-libs/tracking/personalization/core/services/personalization-context.service.ts","../../../feature-libs/tracking/personalization/core/public_api.ts","../../../feature-libs/tracking/personalization/core/spartacus-tracking-personalization-core.ts"],"sourcesContent":["/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport { NgModule } from '@angular/core';\n\n@NgModule({})\nexport class PersonalizationCoreModule {}\n","/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport { Injectable, inject, isDevMode } from '@angular/core';\nimport {\n  CmsService,\n  ContentSlotComponentData,\n  LoggerService,\n  Page,\n} from '@spartacus/core';\nimport { PersonalizationConfig } from '@spartacus/tracking/personalization/root';\nimport { EMPTY, Observable } from 'rxjs';\nimport { filter, map } from 'rxjs/operators';\nimport { PersonalizationContext } from '../model/personalization-context.model';\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class PersonalizationContextService {\n  protected logger = inject(LoggerService);\n\n  constructor(\n    protected config: PersonalizationConfig,\n    protected cmsService: CmsService\n  ) {}\n\n  getPersonalizationContext(): Observable<PersonalizationContext | undefined> {\n    if (!this.config.personalization?.context) {\n      if (isDevMode()) {\n        this.logger.warn(`There is no context configured in Personalization.`);\n      }\n      return EMPTY;\n    } else {\n      const context = this.config.personalization.context;\n      return this.cmsService.getCurrentPage().pipe(\n        filter<Page>(Boolean),\n        map((page: Page) => page.slots?.[context.slotPosition]),\n        filter<any>(Boolean),\n        map((slot) => {\n          const scriptComponent = slot.components?.find(\n            (i: ContentSlotComponentData) => i.uid === context.componentId\n          );\n          return this.buildPersonalizationContext(\n            scriptComponent?.properties?.script?.data\n          );\n        })\n      );\n    }\n  }\n\n  private buildPersonalizationContext(\n    data: string\n  ): PersonalizationContext | undefined {\n    if (data) {\n      const context = JSON.parse(atob(data));\n      context.actions.forEach((action: any) => {\n        Object.keys(action).forEach((key) => {\n          action[key] = atob(action[key]);\n        });\n      });\n      for (let i = 0; i < context.segments.length; i++) {\n        context.segments[i] = atob(context.segments[i]);\n      }\n      return context;\n    }\n  }\n}\n","/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nexport * from './model/personalization-context.model';\nexport * from './personalization-core.module';\nexport * from './services/personalization-context.service';\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public_api';\n"],"names":[],"mappings":"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"}